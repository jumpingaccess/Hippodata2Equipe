<!-- app/views/import/index.html.erb -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Import from Hippodata</title>
  <%= stylesheet_link_tag 'application' %>
  <%= javascript_include_tag 'application' %>
</head>
<body>
  <div id="import-container">
    <h3>Import from Hippodata</h3>
    <div id="search-step">
      <form id="search-form">
        <div class="form-group">
          <label for="show-id">Show ID (FEI Event ID):</label>
          <input type="text" id="show-id" name="show_id" class="form-control" placeholder="Enter FEI Event ID" required>
        </div>
        <button type="submit" class="btn btn-primary" id="search-button">Search Event</button>
      </form>
    </div>
    <div id="selection-step" style="display: none;">
      <div id="event-info"></div>
      <div id="loading-status" style="display: none;">Loading...</div>
      <table id="classes-table">
        <thead>
          <tr>
            <th>Class</th>
            <th>Date</th>
            <th>Class Import</th>
            <th>Startlist Import</th>
            <th>Result Import</th>
          </tr>
        </thead>
        <tbody id="classes-table-body"></tbody>
      </table>
      <button type="button" id="import-selected" class="btn btn-primary">Import Selected</button>
    </div>
  </div>
  <script>
    document.getElementById('search-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const showId = document.getElementById('show-id').value;
      fetch('/import/fetch_event_info', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ show_id: showId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          displayEventInfo(data.event, data.classes);
          document.getElementById('search-step').style.display = 'none';
          document.getElementById('selection-step').style.display = 'block';
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => alert('Request failed: ' + error));
    });

    function displayEventInfo(event, classes) {
      document.getElementById('event-info').innerHTML = `
        <h4>${event.name}</h4>
        <p><strong>Event ID:</strong> ${event.id}</p>
        <p><strong>Venue:</strong> ${event.venue}</p>
      `;
      const tbody = document.getElementById('classes-table-body');
      tbody.innerHTML = '';
      classes.forEach((cls, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${cls.nr} ${cls.name}</td>
          <td>${cls.date}</td>
          <td><input type="checkbox" class="class-import" data-id="${cls.id}"></td>
          <td><input type="checkbox" class="startlist-import" data-id="${cls.id}"></td>
          <td><input type="checkbox" class="result-import" data-id="${cls.id}"></td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
