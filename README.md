![Image Alt Text](images/index_extension.png)
![Image Alt Text](images/competitions_screen.png)
![Image Alt Text](images/checkbox_to_import.png)
# Equipe Extension - Hippodata Import

This extension allows importing competitions, start lists and results from the Hippodata API to Equipe.

## Features

- **Import competitions/classes**: Import events with their information (prize money, dates, etc.)
- **Import startlists**: Import riders, horses and entries
- **Import results**: Import complete results with times, faults and rankings
- **Flexible import**: Import separately or in combination
- **Smart duplicate management**: Avoids duplication of existing riders and horses
- **Multi-round support**: Handles up to 6 rounds per competition
- **Debug mode**: Detailed operation display for troubleshooting

## Installation

### 1. Prerequisites

- PHP >= 7.4
- Composer
- Web server with HTTPS (required for iframe cookies)
- Equipe account with API access
- Hippodata API access with Bearer token

### 2. Install dependencies

```bash
composer install
```

### 3. Configuration

1. Copy the `.env.php.example` file to `.env.php`
```bash
cp .env.php.example .env.php
```

2. Edit `.env.php` and add your keys:
```php
<?php
return [
    'EQUIPE_SECRET' => 'your-equipe-jwt-key',
    'HIPPODATA_BEARER' => 'your-hippodata-bearer-token',
    'DEBUG' => '0' // Set to '1' to enable debug mode
];
```

### 4. File structure

```
/
├── index.php                 # Main entry point
├── composer.json            # PHP dependencies
├── .env.php.example         # Configuration template
├── .env.php                 # Configuration (create, ignored by git)
├── css/
│   └── custom.css          # Custom styles (optional)
└── vendor/                  # Dependencies (generated by composer)
```

## Equipe Configuration

### 1. Create the extension in Equipe

1. Go to organization settings
2. Create a new extension
3. Configure:
   - **Base URL**: `https://your-domain.com/path-to-extension/`
   - **JWT Secret**: Generate and copy to `.env.php`
   - **Type**: Modal/Browser

### 2. Add actions

Create an action:
- **Name**: `import_from_hippodata`
- **Label**: "Import from Hippodata"
- **Context**: Meeting
- **Type**: Modal or Browser

## Usage

### Import Interface

1. In Equipe, open a meeting
2. Click on "Import from Hippodata" action
3. In the window that opens:
   - Enter the FEI event identifier
   - Select items to import:
     - ☐ Import classes (competitions)
     - ☐ Import startlists (riders & horses)
     - ☐ Import results
   - Click "Start Import Process"

### Import Options

#### Import classes only
- Imports competitions with their information
- Creates competitions in Equipe with:
  - Name and sponsor
  - Date and venue
  - Prize money amount
  - Currency

#### Import startlists
- Can be done with or without class import
- Imports:
  - **Riders**: First name, last name, country, FEI ID
  - **Horses**: Name, gender, birth year, owner, FEI ID
  - **Entries**: Links between riders, horses and competitions
- Automatically avoids duplicates based on FEI IDs

#### Import results
- Can be done with or without other imports
- Imports for each round:
  - Obstacle faults
  - Time taken
  - Time penalties
  - Final ranking
  - Prize money won
- Handles special statuses:
  - Eliminated (D)
  - Retired (U)
  - Disqualified (S)
  - Withdrawn (Ö)
- Supports team competitions

### Possible Combinations

- ✅ **Classes only**: To prepare the meeting
- ✅ **Startlists only**: If classes already exist
- ✅ **Results only**: To update after competition
- ✅ **Classes + Startlists**: Complete import before competition
- ✅ **Classes + Results**: Import after with results
- ✅ **Startlists + Results**: Complete update
- ✅ **Everything**: Complete import at once

## Data Mapping

### Competitions
| Hippodata | Equipe | Description |
|-----------|---------|-------------|
| ID | foreign_id | Unique identifier |
| NR | - | Class number (used for APIs) |
| NAME/SPONSOR | klass | Competition name |
| DATE | datum | Competition date |
| PRIZE.MONEY | prsum1 | Total prize money |
| PRIZE.CURRENCY | premie_curr | Currency |

### Riders
| Hippodata | Equipe | Description |
|-----------|---------|-------------|
| RFEI_ID | foreign_id/fei_id | FEI identifier |
| RNAME | first_name, last_name | Name (parsed) |
| NATION | country | Country |

### Horses
| Hippodata | Equipe | Description |
|-----------|---------|-------------|
| HFEI_ID | foreign_id/fei_id | FEI identifier |
| HNAME | name | Horse name |
| HNR | num | Number |
| GENDER | sex | Gender (M→val, F→sto, G→val) |
| BORNYEAR | born_year | Birth year |
| OWNER | owner | Owner |

### Results
| Hippodata | Equipe | Description |
|-----------|---------|-------------|
| RANK | re | Ranking |
| FAULTS | grundf, omh1f, etc. | Faults per round |
| TIME | grundt, omh1t, etc. | Time per round |
| TIMEFAULTS | tfg, tf1, etc. | Time penalties |
| PRIZE.MONEY | premie | Prize money won |
| STATUS | or, a | Status (eliminated, etc.) |

## Debug Mode

Enable debug mode in `.env.php`:
```php
'DEBUG' => '1'
```

This displays:
- API requests made
- Data received and sent
- Transaction UUIDs for rollback
- Import details per competition

## Security

- JWT verification on each request
- Tokens stored outside source code
- HTTPS required for iframe cookies
- Input data validation
- CORS headers configured for app.equipe.com

## Troubleshooting

### Extension doesn't load

Check:
- HTTPS enabled on your server
- CORS configuration in index.php
- Correct JWT token in .env.php

### "FEI ID is required"

The FEI event identifier is mandatory. Format: integer number.

### Hippodata authentication error

Check:
- Bearer token in `.env.php`
- Token validity and permissions
- Format: `Bearer YOUR_TOKEN`

### Partial import

If some competitions don't import:
- Check logs in debug mode
- Some classes may not have startlist/results
- Check competition status (official, cancelled, etc.)

### Duplicate riders/horses

The extension automatically avoids duplicates by checking:
- The `foreign_id` (FEI ID)
- The `fei_id` field
If duplicates appear, verify that FEI IDs are correct.

## API Endpoints Used

### Hippodata
- `/scoring/event/{eventId}`: Event information
- `/scoring/event/{eventId}/startlist/{classNr}/all`: Start lists
- `/scoring/event/{eventId}/resultlist/{classNr}`: Results

### Equipe
- `/batch`: Bulk import
- `/people.json`: List of existing people
- `/horses.json`: List of existing horses

## Support

For any questions or issues:
- Equipe API Documentation: http://api-docs.equipe.com/
- Equipe Support: support@equipe.com
- Server logs for PHP errors
- Debug mode to trace operations
